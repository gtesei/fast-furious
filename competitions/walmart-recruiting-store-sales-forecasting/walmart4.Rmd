Walmart Recruiting Store Sales Forecasting
========================================================

Content 
-------------------------
1. **Generating a feature set (file) for each dept and store**
2. **Fitting with a liner regressor and see submitted results**
3. **Fitting sales time series and see submitted results**

.

1. Generating a feature set (file) for each dept and store
-------------------------

see walmart1.Rmd 

2. Fitting with a liner regressor and see submitted results 
-------------------------

```{r,warning=F} 

##### utils  
library(leaps)
library(glmnet)
library (pls)
library (splines)
library (randomForest)
library (gbm)

kfolds = function(k,data.length) {
  folds = rep(NA,data.length)
  labels = 1:data.length
  st = floor(data.length/k)
  al_labels = NULL
  for (s in 1:k) {
    x = NULL
    if (is.null(al_labels))
      x = sample(labels,st)
    else
      x = sample(labels[-al_labels],st)
    
    folds[x] = s
    if (is.null(al_labels))
      al_labels = x
    else
      al_labels = c(al_labels,x)
    }
  ss = 1
  for (s in 1:length(folds)){
    if (is.na(folds[s])) {
      folds[s] = ss
      ss = ss + 1
      } 
    }
  folds
}

predict.regsubsets =function (reg , formula , newdata ,id ,...){
  #form=as.formula(reg$call [[2]])
  form = as.formula(formula)
  mat=model.matrix(form,newdata)
  coefi=coef(reg ,id=id)
  xvars=names(coefi)
  mat[,xvars]%*%coefi 
}

getWMAE = function(pred, data  ) {
    ares = abs(pred - data$Weekly_Sales)
    l = dim(data)[1] 
    w = 1 * (!data$IsHoliday) + 5 * data$IsHoliday
    wmae = sum(ares * w) / (sum(w))
}

# returns string w/o leading or trailing whitespace
trim = function (x) gsub("^\\s+|\\s+$", "", x)

# build id as concatenation of Store and Dept 
buildId = function(x) {  
  prefix = paste(trim(as.character(x[1])),'_',sep='') 
  id = paste(prefix,trim(as.character(x[2])),sep='')
}

### load files 
#base.path = "/Users/gino/kaggle/fast-furious/gitHub/fast-furious/dataset/walmart-recruiting-store-sales-forecasting/"

base.path = "C:/docs/ff/gitHub/fast-furious/dataset/walmart-recruiting-store-sales-forecasting/"


train.fn = paste(base.path,"train.zat",sep="")
test.fn = paste(base.path,"test.zat",sep="")
sampleSubmission.fn = paste(base.path,"sampleSubmission.zat",sep="")
features.fn = paste(base.path,"features.zat",sep="")
stores.fn = paste(base.path,"stores.zat",sep="")

#train.csv = read.csv(train.fn)
test.csv = read.csv(test.fn)
#sampleSubmission.csv = read.csv(sampleSubmission.fn)
#features.csv = read.csv(features.fn)
#stores.csv = read.csv(stores.fn)

##
#train.csv$Date = as.character(train.csv$Date)
test.csv$Date = as.character(test.csv$Date)
#features.csv$Date = as.character(features.csv$Date)

test.csv$id = apply(test.csv,1, buildId)
#train.csv$id = apply(train.csv,1, buildId)

head(test.csv)
tail(test.csv)
ids = unique(test.csv$id)
ids.num = length(ids)

ids.num

```

Processing each id 

```{r,warning=F} 

miss.id.train = NULL

c = 0
for (id in ids) {
  print("############################################################################## processing id:")
  print(id)
  fn.tr = paste(paste(paste(base.path,"gen/",sep=''),id,sep=''),'_train.zat',sep='')
  fn.ts = paste(paste(paste(base.path,"gen/",sep=''),id,sep=''),'_test.zat',sep='')
  
  if (! file.exists(fn.tr) ){
    print(paste("no train set present for id ",id,sep=''))
    if (is.null(miss.id.train)) 
      miss.id.train = c(id)
    else 
      miss.id.train = c(miss.id.train,id)
  } 
  
  train.csv = read.csv(fn.tr)
  test.csv = read.csv(fn.tr)
  
  #print(head(train.csv))
  
  #######
  train.data.full = data.frame(Weekly_Sales = train.csv$Weekly_Sales  , 
                               Temperature = train.csv$Temperature, Fuel_Price = train.csv$Fuel_Price ,
                               CPI = train.csv$CPI , Unemployment = train.csv$Unemployment , 
                               IsHoliday = train.csv$IsHoliday.y , MarkDown1 = train.csv$MarkDown1 , 
                               MarkDown2 = train.csv$MarkDown2 , 
                               MarkDown3 = train.csv$MarkDown3 , MarkDown4 = train.csv$MarkDown4 ,
                               MarkDown5 = train.csv$MarkDown5 )

  train.data.red = data.frame(Weekly_Sales = train.csv$Weekly_Sales  , 
                              Temperature = train.csv$Temperature, Fuel_Price = train.csv$Fuel_Price , 
                              CPI = train.csv$CPI , Unemployment = train.csv$Unemployment , 
                              IsHoliday = train.csv$IsHoliday.y )
  
  
  train.data.full = na.omit(train.data.full)   ### 1 
  train.data.red = na.omit(train.data.red)     ### 2 
  
  ###################################################
  #  MODEL CODES 
  ###################################################
  # 
  #  11 - full dataset / (forward) stepwise selection 
  #  12 - full dataset / (forward) stepwise selection + splines           
  #  13 - full dataset / ridge regression 
  #  14 - full dataset / ridge regression   + splines            
  #  15 - full dataset / lasso reegression   
  #  16 - full dataset / lasso reegression  + splines  
  #  17 - full dataset / splines  
  #  18 - full dataset / pca  
  #  19 - full dataset / pca + splines   
  #  20 - full dataset / random forest    
  #  21 - full dataset / random forest + splines  
  #
  #####################################################
  #
  #  41 - reduced dataset / (forward) stepwise selection 
  #  42 - reduced dataset / (forward) stepwise selection + splines           
  #  43 - reduced dataset / ridge regression 
  #  44 - reduced dataset / ridge regression   + splines            
  #  45 - reduced dataset / lasso reegression   
  #  46 - reduced dataset / lasso reegression  + splines  
  #  47 - reduced dataset / splines  
  #  48 - reduced dataset / pca  
  #  49 - reduced dataset / pca + splines   
  #  40 - reduced dataset / random forest    
  #  41 - reduced dataset / random forest + splines  
  #
  ######################################################
  


  ###################################################
  #  MODEL PATRAMETRS 
  ###################################################
  # 
  #  11 - full dataset / (forward) stepwise selection 
  spw.sel.mae.full = NULL
  spw.sel.m.min.full = NULL
  
  #  12 - full dataset / (forward) stepwise selection + splines   
  spw.sel.spl.mae.full = NULL
  
  #  13 - full dataset / ridge regression 
  ridge.mae.full = NULL
  ridge.l.min.full = NULL
  
  #  14 - full dataset / ridge regression   + splines       
  ridge.spl.mae.full = NULL
  
  #  15 - full dataset / lasso reegression   
  #  16 - full dataset / lasso reegression  + splines  
  #  17 - full dataset / splines  
  spl.mae.full = NULL
  spl.m.min.full = NULL
  
  #  18 - full dataset / pca  
  pca.mae.full = NULL
  
  #  19 - full dataset / pca + splines   
  #  20 - full dataset / random forest    
  rf.mae.full = NULL
  rf.mae.spl.full = NULL
  
  #  21 - full dataset / random forest + splines  
  boost.mae.full = NULL
  boost.spl.mae.full = NULL
  
  #
  #####################################################
  #
  #  41 - reduced dataset / (forward) stepwise selection 
  spw.sel.mae.red = NULL
  spw.sel.m.min.red = NULL
  
  #  42 - reduced dataset / (forward) stepwise selection + splines  
  spw.sel.spl.mae.red = NULL
  
  #  43 - reduced dataset / ridge regression 
  ridge.mae.red = NULL
  ridge.l.min.red = NULL
  
  #  44 - reduced dataset / ridge regression   + splines        
  ridge.spl.mae.red = NULL
  
  #  45 - reduced dataset / lasso reegression   
  #  46 - reduced dataset / lasso reegression  + splines  
  #  47 - reduced dataset / splines  
  spl.mae.red = NULL
  spl.m.min.red = NULL
  
  #  48 - reduced dataset / pca  
  pca.mae.red = NULL
  
  #  49 - reduced dataset / pca + splines   
  #  40 - reduced dataset / random forest    
  rf.mae.red = NULL
  rf.mae.spl.red = NULL
  
  #  41 - reduced dataset / random forest + splines  
  boost.mae.red = NULL
  boost.spl.mae.red = NULL
  
  #
  ######################################################
  
  for (data.type in 1:2) { 
    traindata = NULL
    
    if (data.type == 1) {  
      print("----------------------------------> DATA FULL")
      traindata = train.data.full
      print(dim(traindata))
    } else {
        print("--------------------------------> DATA RED")
        traindata = train.data.red
        print(dim(traindata))
    }
    
    ####### 1) select features (+ splines)
    form="Weekly_Sales ~ ."
    
    # k-fold
    k=10
    folds = kfolds(k,nrow(traindata)) 
    
    var.feat = length(names(traindata)) - 1
    
    cv.errors=matrix(NA,k,var.feat, dimnames=list(NULL, paste(1:var.feat)))
    cv.mae=matrix(NA,k,var.feat, dimnames=list(NULL, paste(1:var.feat)))
    cv.wmae=matrix(NA,k,var.feat, dimnames=list(NULL, paste(1:var.feat)))
    
    for(j in 1:k) {
      best.fit = regsubsets( Weekly_Sales ~ . , data = traindata[folds!=j,], nvmax = var.feat)
      for (i in (1:var.feat) ) {
        pred = predict(best.fit , form, traindata[folds==j,] , id = i)
        cv.errors[j,i] = mean((traindata$Weekly_Sales[folds==j]-pred)^2)
        cv.mae[j,i] = mean(abs((traindata$Weekly_Sales[folds==j]-pred)))
        cv.wmae[j,i] = getWMAE(pred , traindata[folds==j , ] )
        } 
      }
    
    ## MAE
    mean.cv.mae=apply(cv.mae ,2,mean)
    m = which.min(mean.cv.mae)
    
    if (data.type == 1) {  
      spw.sel.mae.full = min(mean.cv.mae)
      spw.sel.m.min.full = m 
      
      print("spw.sel.mae.full")
      print(spw.sel.mae.full)
      print("spw.sel.m.min.full")
      print(spw.sel.m.min.full)
    } else {
        spw.sel.mae.red = min(mean.cv.mae)
        spw.sel.m.min.red = m 
        
        print("spw.sel.mae.red")
        print(spw.sel.mae.red)
        print("spw.sel.m.min.red")
        print(spw.sel.m.min.red)
    }
    #######################
    
    ### Splines 
    cv.errors=matrix(NA,k,1, dimnames=list(NULL, paste(1:1)))
    cv.mae=matrix(NA,k,1, dimnames=list(NULL, paste(1:1)))
    cv.wmae=matrix(NA,k,1, dimnames=list(NULL, paste(1:1)))
    
    for(j in 1:k) {
      best.fit = regsubsets( Weekly_Sales ~ . , data = traindata[folds!=j,], nvmax = var.feat)
      mod.prd = predict(best.fit , "Weekly_Sales ~ .", traindata[folds!=j,] , id = m)
      mod.prd.test = predict(best.fit , "Weekly_Sales ~ .", traindata[folds==j,] , id = m)
     
      pred = NULL
      
      tryCatch({
        spl.fit = smooth.spline(x=mod.prd,y=traindata[folds!=j,1],cv=TRUE )
        pred = predict(spl.fit , mod.prd.test   )$y 
      }, error = function(e) {
          #print(e)
      })
  
      cv.errors[j,1] = mean((traindata$Weekly_Sales[folds==j]-pred)^2)
      cv.mae[j,1] = mean(abs((traindata$Weekly_Sales[folds==j]-pred)))
      cv.wmae[j,1] = getWMAE(pred , traindata[folds==j , ] )    
    }
    
    ## MAE
    mean.cv.mae=apply(cv.mae ,2,mean)
    
    if (data.type == 1) {  
        spw.sel.spl.mae.full = min(mean.cv.mae)
        if (is.nan(spw.sel.spl.mae.full))
          spw.sel.spl.mae.full = 100000
        
        print("spw.sel.spl.mae.full")
        print(spw.sel.spl.mae.full)
    } else {
        spw.sel.spl.mae.red = min(mean.cv.mae)
        if (is.nan(spw.sel.spl.mae.red))
          spw.sel.spl.mae.red = 100000
        
        print("spw.sel.spl.mae.red")
        print(spw.sel.spl.mae.red)
    }
    
    ####### 2) ride regression (+ splines)
    cv.errors=matrix(NA,k,1, dimnames=list(NULL, paste(1:1)))
    cv.mae=matrix(NA,k,1, dimnames=list(NULL, paste(1:1)))
    cv.wmae=matrix(NA,k,1, dimnames=list(NULL, paste(1:1)))
    
    cv.errors.spline=matrix(NA,k,1, dimnames=list(NULL, paste(1:1)))
    cv.mae.spline=matrix(NA,k,1, dimnames=list(NULL, paste(1:1)))
    cv.wmae.spline=matrix(NA,k,1, dimnames=list(NULL, paste(1:1)))
    
    for(j in 1:k) {
      x=model.matrix(Weekly_Sales~.,traindata[folds != j,])[,-1]
      y=traindata$Weekly_Sales[folds != j]
      grid=10^seq(10,-2,length=100)
      cv.out=cv.glmnet(x,y,alpha=0 , nfolds=10)
      bestlam=cv.out$lambda.min 
     
      pred = NULL
      
      x.test=model.matrix(Weekly_Sales~.,traindata[folds == j,])[,-1]
      pred=predict(cv.out,s=bestlam ,newx=x.test)
      
      cv.errors[j,1] = mean((traindata$Weekly_Sales[folds==j]-pred)^2)
      cv.mae[j,1] = mean(abs((traindata$Weekly_Sales[folds==j]-pred)))
      cv.wmae[j,1] = getWMAE(pred , traindata[folds==j , ] )  
      
      ###### Splines   
      pred = NULL
      mod.prd = predict(cv.out,s=bestlam ,newx=x)
      mod.prd.test = predict(cv.out,s=bestlam ,newx=x.test)
      tryCatch({
        spl.fit = smooth.spline(x=mod.prd,y=traindata$Weekly_Sales[folds != j],cv=TRUE)
        pred = predict(spl.fit , mod.prd.test   )$y
      }, error = function(e) {
        #print(e)
      })
      
      cv.errors.spline[j,1] = mean((traindata$Weekly_Sales[folds==j]-pred)^2)
      cv.mae.spline[j,1] = mean(abs((traindata$Weekly_Sales[folds==j]-pred)))
      cv.wmae.spline[j,1] = getWMAE(pred , traindata[folds==j , ] )  
      
      ###### end of Splines 
    }
    
    ## MAE
    mean.cv.mae=apply(cv.mae ,2,mean)
    mean.cv.mae.spline=apply(cv.mae.spline ,2,mean)
    
    if (data.type == 1) {  
      ridge.mae.full = min(mean.cv.mae)
      if (is.nan(ridge.mae.full))
        ridge.mae.full = 100000
      
      print("ridge.mae.full")
      print(ridge.mae.full)
      
      ridge.l.min.full = bestlam
      print("ridge.l.min.full")
      print(ridge.l.min.full)
      
      ridge.spl.mae.full = min(mean.cv.mae.spline)
      if (is.nan(ridge.spl.mae.full))
        ridge.spl.mae.full = 100000
      
      print("ridge.spl.mae.full")
      print(ridge.spl.mae.full)
      
    } else {
      ridge.mae.red = min(mean.cv.mae)
      if (is.nan(ridge.mae.red))
        ridge.mae.red = 100000
      
      print("ridge.mae.red")
      print(ridge.mae.red)
      
      ridge.l.min.red = bestlam
      print("ridge.l.min.red")
      print(ridge.l.min.red)
      
      ridge.spl.mae.red = min(mean.cv.mae.spline)
      if (is.nan(ridge.spl.mae.red))
        ridge.spl.mae.red = 100000
      
      print("ridge.spl.mae.red")
      print(ridge.spl.mae.red)
      
    }
    
    ####### 3) splines 
    print("Splines ... ")
    fform = "Weekly_Sales ~ .+ ns(Temperature) + ns(Fuel_Price) + ns(CPI)  + ns(Unemployment) "
    
    # k-fold
    tryCatch({
    
    var.feat = length(names(traindata)) - 1
    
    cv.errors=matrix(NA,k,var.feat, dimnames=list(NULL, paste(1:var.feat)))
    cv.mae=matrix(NA,k,var.feat, dimnames=list(NULL, paste(1:var.feat)))
    cv.wmae=matrix(NA,k,var.feat, dimnames=list(NULL, paste(1:var.feat)))
    
    for(j in 1:k) {
      best.fit = regsubsets( as.formula(fform) , data = traindata[folds!=j,], nvmax = var.feat)
      for (i in (1:var.feat) ) {
        pred = predict(best.fit , as.formula(fform), traindata[folds==j,] , id = i)
        cv.errors[j,i] = mean((traindata$Weekly_Sales[folds==j]-pred)^2)
        cv.mae[j,i] = mean(abs((traindata$Weekly_Sales[folds==j]-pred)))
        cv.wmae[j,i] = getWMAE(pred , traindata[folds==j , ] )
        } 
    }
    
    ## MAE
    mean.cv.mae=apply(cv.mae ,2,mean)
    m = which.min(mean.cv.mae)
    
    if (data.type == 1) {  
      spl.mae.full = min(mean.cv.mae)
      spl.m.min.full = m 
      
      print("spl.mae.full")
      print(spl.mae.full)
      print("spl.m.min.full")
      print(spl.m.min.full)
    } else {
        spl.mae.red = min(mean.cv.mae)
        spw.m.min.red = m 
        
        print("spl.mae.red")
        print(spl.mae.red)
        print("spl.m.min.red")
        print(spl.m.min.red)
    }
    }, error = function(e) {
        #print(e)
    })

    ####### 4) lasso reegression (+ splines)
    
    ####### 5) pca (+splines)
    
    ##### 6) Random forest 
    cv.errors=matrix(NA,k,1, dimnames=list(NULL, paste(1:1)))
    cv.mae=matrix(NA,k,1, dimnames=list(NULL, paste(1:1)))
    cv.wmae=matrix(NA,k,1, dimnames=list(NULL, paste(1:1)))
    
    for(j in 1:k) {
      rf =randomForest(Weekly_Sales~. ,data=traindata[folds != j,] , importance =TRUE)
     
      pred = predict (rf ,newdata = traindata[folds == j,])
    
      cv.errors[j,1] = mean((traindata$Weekly_Sales[folds==j]-pred)^2)
      cv.mae[j,1] = mean(abs((traindata$Weekly_Sales[folds==j]-pred)))
      cv.wmae[j,1] = getWMAE(pred , traindata[folds==j , ] )    
      
      ###### Splines   
      pred = NULL
      mod.prd = predict (rf ,newdata = traindata[folds != j,])
      mod.prd.test = predict (rf ,newdata = traindata[folds == j,])
      tryCatch({
        spl.fit = smooth.spline(x=mod.prd,y=traindata$Weekly_Sales[folds != j],cv=TRUE)
        pred = predict(spl.fit , mod.prd.test   )$y
      }, error = function(e) {
        #print(e)
      })
      
      cv.errors.spline[j,1] = mean((traindata$Weekly_Sales[folds==j]-pred)^2)
      cv.mae.spline[j,1] = mean(abs((traindata$Weekly_Sales[folds==j]-pred)))
      cv.wmae.spline[j,1] = getWMAE(pred , traindata[folds==j , ] )  
    }
    
    ## MAE
    mean.cv.mae=apply(cv.mae ,2,mean)
    mean.cv.mae.spline=apply(cv.mae.spline ,2,mean)
    
    if (data.type == 1) {  
      rf.mae.full = min(mean.cv.mae)
      rf.mae.spl.full = min(mean.cv.mae.spline)
      
      print("rf.mae.full")
      print(rf.mae.full)
      print("rf.mae.spl.full")
      print(rf.mae.spl.full)
    } else {
      rf.mae.red = min(mean.cv.mae)
      rf.mae.spl.red = min(mean.cv.mae.spline)
      
      print("rf.mae.red")
      print(rf.mae.red)
      print("rf.mae.spl.red")
      print(rf.mae.spl.red)
    }
  
    ##### 7) Boosting 
    cv.errors=matrix(NA,k,1, dimnames=list(NULL, paste(1:1)))
    cv.mae=matrix(NA,k,1, dimnames=list(NULL, paste(1:1)))
    cv.wmae=matrix(NA,k,1, dimnames=list(NULL, paste(1:1)))
    
    for(j in 1:k) {
      tryCatch({
      boost = gbm(Weekly_Sales~., data=traindata[folds != j,] , distribution="gaussian", n.trees =5000 , interaction.depth =4)
      
      pred = predict (boost , newdata = traindata[folds == j,] , n.trees = 5000)
    
      cv.errors[j,1] = mean((traindata$Weekly_Sales[folds==j]-pred)^2)
      cv.mae[j,1] = mean(abs((traindata$Weekly_Sales[folds==j]-pred)))
      cv.wmae[j,1] = getWMAE(pred , traindata[folds==j , ] )    
      
      ###### Splines   
      pred = NULL
      mod.prd = predict (boost ,newdata = traindata[folds != j,] , n.trees = 5000)
      mod.prd.test = predict (boost ,newdata = traindata[folds == j,] , n.trees = 5000)
      
        spl.fit = smooth.spline(x=mod.prd,y=traindata$Weekly_Sales[folds != j],cv=TRUE)
        pred = predict(spl.fit , mod.prd.test   )$y
      }, error = function(e) {
        #print(e)
      })
      
      cv.errors.spline[j,1] = mean((traindata$Weekly_Sales[folds==j]-pred)^2)
      cv.mae.spline[j,1] = mean(abs((traindata$Weekly_Sales[folds==j]-pred)))
      cv.wmae.spline[j,1] = getWMAE(pred , traindata[folds==j , ] )  
    }
    
    ## MAE
    mean.cv.mae=apply(cv.mae ,2,mean)
    mean.cv.mae.spline=apply(cv.mae.spline ,2,mean)
    
    if (data.type == 1) {  
     boost.mae.full = min(mean.cv.mae)
     boost.spl.mae.full = min(mean.cv.mae.spline)
     
     print("boost.mae.full")
     print(boost.mae.full)
     print("boost.spl.mae.full")
     print(boost.spl.mae.full)
    
    } else {
     boost.mae.red = min(mean.cv.mae)
     boost.spl.mae.red = min(mean.cv.mae.spline)
     
     print("boost.mae.red")
     print(boost.mae.red)
     print("boost.spl.mae.red")
     print(boost.spl.mae.red) 
    }
   
  
    
    
    }
  
  
  
  c = c + 1
  if (c > 10) break 
}

miss.id.train 

```
